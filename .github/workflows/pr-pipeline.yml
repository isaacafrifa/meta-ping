name: PR Pipeline

# This workflow runs on pull requests to the main branch
# PR workflow focused on fast feedback:
# 1) Compile & unit tests  2) Sonar  3) Secret Scan

on:
  pull_request:
    types: [ 'opened', 'synchronize', 'reopened' ]
    # Prevent running the entire workflow when changes are made to the .md files
    paths-ignore:
      - 'README.md'
      - 'enhancement-todos.md'
    branches: [ main ]

jobs:
  compile-and-unit-test:
    runs-on: ubuntu-latest
    # Restrict to read-only access for repository contents in case of vulnerable dependencies
    permissions:
      contents: read
    concurrency:
      # Cancel older runs of this job for the same PR when a new commit arrives
      group: pr-${{ github.ref }}-compile-unit
      cancel-in-progress: true
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Keep history for tooling that needs it

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: maven

      - name: Compile and run unit tests (Surefire)
        # -B batch mode, -ntp no transfer progress → cleaner CI logs (ie. CI‑friendly logging)
        run: mvn -B -ntp clean test
        timeout-minutes: 15

      - name: Upload Surefire reports (if failure)
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: surefire-reports
          path: target/surefire-reports/

  sonar:
    runs-on: ubuntu-latest
    needs: compile-and-unit-test
    # Restrict to read-only access for repository contents in case of vulnerable dependencies
    permissions:
      contents: read
    concurrency:
      # Independently cancel stale Sonar runs per PR
      group: pr-${{ github.ref }}-sonar
      cancel-in-progress: true
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: maven

      - name: SonarCloud Analysis
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        # Run up to 'verify' to generate JaCoCo; skip tests here to avoid re-running them
        run: mvn -B -ntp -DskipITs=true -DskipTests=true verify sonar:sonar
        timeout-minutes: 15

  security-scan:
    runs-on: ubuntu-latest
    needs: [ compile-and-unit-test ]
    # Restrict to read-only access for repository contents in case of vulnerable dependencies
    permissions:
      contents: read
    timeout-minutes: 10 
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          # Full git history is needed for GitLeaks to work properly
          fetch-depth: 0
      
      # Scan for secrets and sensitive information in the codebase
      - name: GitLeaks Secret Scan
        id: gitleaks
        uses: gitleaks/gitleaks-action@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }} # Automatically provided by GitHub, for use during workflow execution
        continue-on-error: true  # Allow the workflow to continue even if leaks are found
      
      # Only upload the SARIF file if leaks were detected
      - name: Upload GitLeaks Results
        uses: actions/upload-artifact@v4
        if: steps.gitleaks.outcome == 'failure'  # Only upload when GitLeaks finds issues
        with:
          name: gitleaks-results
          path: gitleaks-results.sarif
