name: CI Pipeline

# This workflow runs when code is pushed to the main branch (including merges)
on:
  push:
    branches: [ main ]
    # Prevent running the entire workflow when changes are made to the .md files
    paths-ignore:
      - 'README.md'
      - 'enhancement-todos.md'

# Cancel in-progress CI for the same branch/ref when newer commits arrive
concurrency:
  group: ci-${{ github.ref }}
  cancel-in-progress: true


jobs:
  # Compile & Unit tests (Surefire) on push to main
  compile-and-unit-test:
    runs-on: ubuntu-latest
    timeout-minutes: 20
    # Restrict to read-only access for repository contents in case of vulnerable dependencies
    permissions:
      contents: read
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: maven

      - name: Run unit tests (Surefire)
        # -B batch mode, -ntp no transfer progress â†’ cleaner CI logs
        run: mvn -B -ntp clean test
        timeout-minutes: 15

      - name: Upload compiled classes
        uses: actions/upload-artifact@v4
        with:
          name: build-target
          path: target/
          retention-days: 1

      - name: Upload Surefire reports (if failure)
        uses: actions/upload-artifact@v4
        if: failure()
        with:
          name: surefire-reports
          path: target/surefire-reports/

  # Integration tests (Failsafe). Requires Docker for Testcontainers/LocalStack
  integration-tests:
    runs-on: ubuntu-latest
    needs: compile-and-unit-test
    # Restrict to read-only access for repository contents in case of vulnerable dependencies
    permissions:
      contents: read
    timeout-minutes: 35
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: maven

      - name: Download compiled classes
        uses: actions/download-artifact@v4
        with:
          name: build-target
          path: target/

      - name: Run integration tests (Failsafe)
        # Run only ITs: skip unit tests, run Failsafe ITs. No 'clean' to keep downloaded artifact.
        run: mvn -B -ntp verify -DskipTests=true -DskipITs=false
        timeout-minutes: 25

      - name: Upload combined coverage data
        uses: actions/upload-artifact@v4
        with:
          name: build-target-combined
          path: target/
          retention-days: 1

      - name: Upload Failsafe reports (if failure)
        uses: actions/upload-artifact@v4
        if: failure()
        with:
          name: failsafe-reports
          path: target/failsafe-reports/

      - name: Upload Surefire reports (if failure)
        uses: actions/upload-artifact@v4
        if: failure()
        with:
          name: surefire-reports-from-it
          path: target/surefire-reports/

  # SonarCloud analysis (Quality Gate)
  sonar:
    runs-on: ubuntu-latest
    needs: integration-tests
    # Restrict to read-only access for repository contents in case of vulnerable dependencies
    permissions:
      contents: read
    timeout-minutes: 20
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: maven

      - name: Download combined coverage data
        uses: actions/download-artifact@v4
        with:
          name: build-target-combined
          path: target/

      - name: SonarCloud analysis
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        # Run verify to ensure JaCoCo reports are processed, then run sonar
        run: mvn -B -ntp -DskipITs=true -DskipTests=true verify sonar:sonar

  # Scan for security issues and secrets (Runs in parallel)
  security-scan:
    runs-on: ubuntu-latest
    # Restrict to read-only access for repository contents in case of vulnerable dependencies
    permissions:
      contents: read
    timeout-minutes: 10 # timeout for 'security-scan' job

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        # Full git history is needed for GitLeaks to work properly
        fetch-depth: 0

    # Scan for secrets and sensitive information in the codebase
    - name: GitLeaks Secret Scan
      id: gitleaks
      uses: gitleaks/gitleaks-action@v2
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      continue-on-error: true  # Allow the workflow to continue even if leaks are found

    # Only upload the SARIF file if leaks were detected
    - name: Upload GitLeaks Results
      uses: actions/upload-artifact@v4
      if: steps.gitleaks.outcome == 'failure'  # Only upload when GitLeaks finds issues
      with:
        name: gitleaks-results
        path: gitleaks-results.sarif
